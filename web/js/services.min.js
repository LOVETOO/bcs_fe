define(["app","swalApi"],function(app,swalApi){service={pagelist:[],openCommonModal:function(o){console.log("openCommonModal: "+o);if(angular.element("#commonModal").next().attr("id")!="commonModal1"){var $div=angular.element("#commonModal").after(angular.element("#commonModal").clone(true).attr({display:"none",id:"commonModal1"}));service.divresize($div)}else{angular.element("#commonModal").remove();var $div=angular.element("#commonModal1").clone(true).attr({display:"block",id:"commonModal"});angular.element("#commonModal1").before($div);service.divresize($div)}$("#commonModalFrame").attr("src",o.url);if(o.title){$("#commonModalTitle").html(o.title)}if(o.ondestroy){this.onDestroy=o.ondestroy}$("#commonModal").modal({backdrop:"static",keyboard:false});$("#commonModal").modal({backdrop:"static",keyboard:false});if(o.style){$("#commonModal").children(":first").css(o.style)}if(o.windowMax===true){$("#commonModal .modmax").click()}var iframe=document.getElementById("commonModalFrame");if(iframe.attachEvent){iframe.attachEvent("onload",function(){if(iframe.contentWindow.setData){iframe.contentWindow.setData(o)}})}else{iframe.onload=function(){if(iframe.contentWindow.setData){iframe.contentWindow.setData(o)}}}},onDestroy:null,closeCommonModal:function(){$("#commonModal").modal("hide");if(this.onDestroy){this.onDestroy()}},currWfCtrl:null,currModalH:null,divresize:function(div){div.find(".ui-widget-content").resizable({distance:0,minHeight:440});div.find(".ui-widget-content").resize(function(){var mH=$(this).height();var mhH=$(this).children().children(".modal-header").outerHeight(true);$(this).children().children(".modal-body").css("height",mH-mhH);div.find("body").css("overflow","auto")});div.find(".ui-resizable-se,.ui-resizable-s,.ui-resizable-e").mousedown(function(){div.find(".ui-resizable").addClass("resizing");div.find(".ui-resizable-se").closest("body").on("mouseup",mouseup1);console.log("resize-mousedown")});function mouseup1(){div.find(".ui-resizable").removeClass("resizing");div.find(".ui-resizable-se").closest("body").off("mouseup",mouseup1);console.log("resize-mouseup")}}};window.CloseOwnerWindow=function(){};function BaseService($http,$q,$modal,notify,$location,$timeout){this.controller=null;this.FrmInfo;var _this=this;var self=this;this.wfInfo=null;this.requestUrl="/jsp/authman.jsp";this.editObj={key:"",value:"",obj:null};this.setEditObj=function(obj){this.editObj=obj};this.getEditObj=function(){if(this._loadStorage("currEditObj")){return this._loadStorageObj("currEditObj")}else return this.editObj};this.pages=[];this.getPages=function(){return this.pages};this.pushPage=function(page){this.pages.push(page)};this.removePage=function(page){};this.pageInit=function($scope){$scope.oldPage=1;$scope.currentPage=1;$scope.pageSize="10";$scope.totalCount=1;$scope.pages=1;$scope.search=function(params){var postdata={pagination:"pn=1,ps="+$scope.pageSize+",pc=0,cn=0,ci=0"};if(params){postdata.params=params}$scope._pageLoad(postdata)};$scope.keyup=function(e){var keycode=window.event?e.keyCode:e.which;if(keycode==13){if($scope.oldPage!=$scope.currentPage&&$scope.currentPage>0&&$scope.currentPage<=$scope.pages){var postdata={pagination:"pn="+$scope.currentPage+",ps="+$scope.pageSize+",pc=0,cn=0,ci=0"};$scope._pageLoad(postdata)}}};$scope.firstpage=function(){if($scope.currentPage<=1){return}var postdata={pagination:"pn=1,ps="+$scope.pageSize+",pc=0,cn=0,ci=0"};$scope._pageLoad(postdata)};$scope.prevpage=function(){if($scope.currentPage==1)return;var num=Number($scope.currentPage)-1;var postdata={pagination:"pn="+num+",ps="+$scope.pageSize+",pc=0,cn=0,ci=0"};$scope._pageLoad(postdata)};$scope.nextpage=function(){if($scope.currentPage>=$scope.pages)return;var num=Number($scope.currentPage)+1;var postdata={pagination:"pn="+num+",ps="+$scope.pageSize+",pc=0,cn=0,ci=0"};$scope._pageLoad(postdata)};$scope.lastpage=function(){if($scope.currentPage>=$scope.pages){return}var postdata={pagination:"pn="+$scope.pages+",ps="+$scope.pageSize+",pc=0,cn=0,ci=0"};$scope._pageLoad(postdata)};$scope.pschange=function(ps){var postdata={pagination:"pn=1,ps="+ps+",pc=0,cn=0,ci=0"};$scope._pageLoad(postdata)}};this.pageGridInit=function($scope,params){$scope.oldPage=1;$scope.currentPage=1;if(!$scope.pageSize){$scope.pageSize="20"}$scope.totalCount=1;$scope.pages=1;var postdata={pagination:"pn=1,ps="+$scope.pageSize+",pc=0,cn=0,ci=0"};if(params){postdata.params=params}$scope.searchData(postdata);$scope.keyup=function(e){var keycode=window.event?e.keyCode:e.which;if(keycode==13){if($scope.oldPage!=$scope.currentPage&&$scope.currentPage>0&&$scope.currentPage<=$scope.pages){var postdata={pagination:"pn="+$scope.currentPage+",ps="+$scope.pageSize+",pc=0,cn=0,ci=0"};$scope.searchData(postdata)}}};$scope.firstpage=function(){if($scope.currentPage<=1){return}var postdata={pagination:"pn=1,ps="+$scope.pageSize+",pc=0,cn=0,ci=0"};$scope.searchData(postdata)};$scope.prevpage=function(){if($scope.currentPage==1)return;var num=Number($scope.currentPage)-1;var postdata={pagination:"pn="+num+",ps="+$scope.pageSize+",pc=0,cn=0,ci=0"};$scope.searchData(postdata)};$scope.nextpage=function(){if($scope.currentPage>=$scope.pages)return;var num=Number($scope.currentPage)+1;var postdata={pagination:"pn="+num+",ps="+$scope.pageSize+",pc=0,cn=0,ci=0"};$scope.searchData(postdata)};$scope.lastpage=function(){if($scope.currentPage>=$scope.pages){return}var postdata={pagination:"pn="+$scope.pages+",ps="+$scope.pageSize+",pc=0,cn=0,ci=0"};$scope.searchData(postdata)};$scope.pschange=function(ps){var postdata={pagination:"pn=1,ps="+ps+",pc=0,cn=0,ci=0"};$scope.searchData(postdata)}};this._pschange=function($scope,ps){var pc=Math.ceil($scope.totalCount/ps);var pageInfoStr="pn=1,ps="+ps+",pc="+pc+",cn="+$scope.totalCount+",ci=0";this.pageInfoOp($scope,pageInfoStr)};this.RequestPostSync=function(classid,action,data,url){if(classid==undefined){notify({message:"类名必须赋值",classes:"alert-danger",templateUrl:"views/common/notify.html"});return}if(action==undefined){notify({message:"操作必须赋值",classes:"alert-danger",templateUrl:"views/common/notify.html"});return}var requestUrl=this.requestUrl;requestUrl=url||requestUrl;requestUrl=requestUrl+"?loginguid="+window.strLoginGuid+"&format=mjson&classid="+classid+"&id="+Math.random()+"&action="+action;IncRequestCount("post");r=$.ajax({type:"POST",url:requestUrl,dataType:"json",processData:false,contentType:"application/json",data:JSON.stringify(data),async:false});DecRequestCount();if(r.status!=200){error=r.responseJSON;if(error==""||error==undefined){notify({message:"未知异常",classes:"alert-danger",templateUrl:"views/common/notify.html"});return{}}else{notify({message:error.message,classes:"alert-danger",templateUrl:"views/common/notify.html"});return{}}}else{return r.responseJSON}};this.RequestPost=function(classid,action,data,show_mb,url){if(classid==undefined||action==undefined){console.error("请求类或方法未定义");return}for(x in data){if(data[x]==null){data[x]=undefined;console.warn(x+" is null")}if(data[x]=="undefined"){data[x]=undefined;console.warn(x+" is undefined String")}}if(url!=undefined)this.requestUrl=url;var deferred=$q.defer();if(show_mb){}else{IncRequestCount("post")}$http({method:"POST",url:this.requestUrl,data:data,params:{classid:classid,action:action,format:"mjson",id:Math.random(),loginguid:window.strLoginGuid}}).success(function(data,status,headers,config){if(show_mb){}else{DecRequestCount()}deferred.resolve(data)}).error(function(data,status,headers,config){if(show_mb){}else{DecRequestCount()}notify.closeAll();if(config.params)console.info("errorcode:"+status+",requestMethod:"+config.params.classid+"."+config.params.action);if(data&&data!=null&&data!=undefined){if(!data.message||data.message=="")data.message="未知异常！";if(!show_mb)notify({message:data.message,classes:"alert-danger",templateUrl:"views/common/notify.html"});deferred.reject(data)}else{notify({message:"网络异常！",classes:"alert-danger",templateUrl:"views/common/notify.html"});console.log("网络异常！");deferred.reject({message:"网络异常！-"+status})}});return deferred.promise};this.RequestPostSync=function(classid,action,data,url){if(classid==undefined){notify({message:"类名必须赋值",classes:"alert-danger",templateUrl:"views/common/notify.html"});return}if(action==undefined){notify({message:"操作必须赋值",classes:"alert-danger",templateUrl:"views/common/notify.html"});return}var requestUrl=this.requestUrl;requestUrl=url||requestUrl;requestUrl=requestUrl+"?loginguid="+window.strLoginGuid+"&format=mjson&classid="+classid+"&id="+Math.random()+"&action="+action;IncRequestCount("post");r=$.ajax({type:"POST",url:requestUrl,dataType:"json",processData:false,contentType:"application/json",data:JSON.stringify(data),async:false});DecRequestCount();if(r.status!=200){error=r.responseJSON;if(error==""||error==undefined){notify({message:"未知异常",classes:"alert-danger",templateUrl:"views/common/notify.html"});return{}}else{notify({message:error.message,classes:"alert-danger",templateUrl:"views/common/notify.html"});return{}}}else{return r.responseJSON}};this.RequestPostAjax=function(classid,action,data,url){try{if(window.GRID_INPUT!=undefined&&window.GRID_INPUT.getValue!=undefined){window.GRID_INPUT.getValue();window.GRID_INPUT.params.stopEditing(true);window.GRID_INPUT.destroy();window.GRID_INPUT=undefined}}catch(e){}if(classid==undefined){notify({message:"类名必须赋值",classes:"alert-danger",templateUrl:"views/common/notify.html"});return}if(action==undefined){notify({message:"操作必须赋值",classes:"alert-danger",templateUrl:"views/common/notify.html"});return}var requestUrl=this.requestUrl;requestUrl=url||requestUrl;requestUrl=requestUrl+"?loginguid="+window.strLoginGuid+"&format=mjson&classid="+classid+"&id="+Math.random()+"&action="+action;var deferred=$q.defer();if(classid=="base_search"&&action.indexOf("searchdict")>-1&&data.dictcode!=undefined&&data.dictcode.length>0){if(HczyCommon.isArray(window.DICTS[data.dictcode])&&window.DICTS[data.dictcode].length>0){deferred.resolve({dicts:window.DICTS[data.dictcode]});return deferred.promise}}data=HczyCommon.stringPropToNum(data);$.ajax({type:"POST",dataType:"json",processData:false,contentType:"application/json",url:requestUrl,data:JSON.stringify(data),async:false,success:function(data,textStatus){deferred.resolve(data);if(classid=="base_search"&&action.indexOf("searchdict")>-1&&data.dictcode!=undefined&&data.dictcode.length>0){if(HczyCommon.isArray(data.dicts)&&data.dicts.length>0){var dicts=data.dicts;if(!HczyCommon.isArray(window.DICTS[data.dictcode])){window.DICTS[data.dictcode]=[]}for(var i=0;i<data.dicts.length;i++){data.dicts[i].id=data.dicts[i].dictvalue;data.dicts[i].name=data.dicts[i].dictname;data.dicts[i].value=data.dicts[i].dictvalue;data.dicts[i].desc=data.dicts[i].dictname;window.DICTS[data.dictcode].push(data.dicts[i])}}}},error:function(XMLHttpRequest,status,errorThrown){notify.closeAll();if(errorThrown){console.info("errorcode:"+status+",requestMethod:"+this.classid+"."+this.action)}if(errorThrown&&errorThrown!=null&&errorThrown!=undefined){if(!errorThrown||errorThrown=="")data.message="未知异常！";notify({message:errorThrown,classes:"alert-danger",templateUrl:"views/common/notify.html"});deferred.reject(data)}else{notify({message:"网络异常！",classes:"alert-danger",templateUrl:"views/common/notify.html"});console.log("网络异常！");deferred.reject({message:"网络异常！-"+status})}}});return deferred.promise};this.RequestPostNoWait=function(classid,action,data,url){var obj={};if(classid==undefined){swalApi.info("类名必须赋值");return}if(action==undefined){swalApi.info("操作必须赋值");return}var requestUrl=this.requestUrl;requestUrl=url||requestUrl;requestUrl=requestUrl+"?loginguid="+window.strLoginGuid+"&format=mjson&classid="+classid+"&id="+Math.random()+"&action="+action;$.ajax({type:"POST",url:requestUrl,dataType:"json",processData:false,contentType:"application/json",data:JSON.stringify(data),async:false,success:function(data,textStatus){obj={data:data,pass:true}},error:function(XMLHttpRequest,status,errorThrown){var error=JSON.parse(XMLHttpRequest.responseText);obj={pass:false,msg:error.message};if(errorThrown){console.info("errorcode:"+status+",requestMethod:"+this.classid+"."+this.action)}if(obj.msg){swalApi(obj.msg)}else if(errorThrown&&errorThrown!=null&&errorThrown!=undefined){if(!errorThrown||errorThrown=="")data.message="未知异常！";swalApi(errorThrown)}else{swalApi("网络异常");console.log("网络异常！")}}});return obj};this.swalDelete=function(title,text,fun){swal({title:title,text:text,type:"warning",showCancelButton:true,closeOnConfirm:false,allowOutsideClick:true},function(bool){if(!bool){if(fun){fun(bool)}}else if(bool){swal({title:"删除!",text:"成功删除!",type:"success",closeOnConfirm:false,allowOutsideClick:true,timer:3e3},function(){sweetAlert.close();if(fun){fun(bool)}})}})};this.swalWarning=function(title,text,fun){swal({title:title,text:text,type:"warning",showCancelButton:true,closeOnConfirm:false,allowOutsideClick:true},function(bool){sweetAlert.close();if(bool){if(fun){fun(bool)}}})};this.swal=function(title,text,fun){swal({title:title,text:text,closeOnConfirm:false,allowOutsideClick:true,timer:3e3},function(){sweetAlert.close();if(fun){fun()}})};this.swalSuccess=function(title,text,fun){swal({title:title,text:text,type:"success",closeOnConfirm:false,allowOutsideClick:true,timer:3e3},function(){sweetAlert.close();if(fun){fun()}})};this.swalError=function(title,text,fun){swal({title:title,text:text,type:"warning",closeOnConfirm:false,allowOutsideClick:true,timer:3e3},function(){sweetAlert.close();if(fun){fun()}})};this.getSqlWhereBlock=function getSqlWhereBlock(SqlWhere,sqlWhereBlockID){if(!(SqlWhere==undefined||SqlWhere=="")){var SqlWhere=SqlWhere+" "}else{var SqlWhere="1=1 "}if(!(sqlWhereBlockID==undefined||sqlWhereBlockID=="")){var sqlWhereBlock=sqlWhereBlockID}else{var sqlWhereBlock="#sqlWhereBlock"}$(sqlWhereBlock).find("input[name='like']").each(function(){if(this.value.length>0){var id=this.id;if(this.id.indexOf("OMS")>0){id=this.id.substr(0,this.id.indexOf("OMS"))}this.value=this.value.replace(/(^\s*)|(\s*$)/g,"");var sql="and lower("+id+") "+this.name+" lower('%"+this.value+"%') ";SqlWhere=SqlWhere+sql}});$(sqlWhereBlock).find("input[name='=']").each(function(){if(this.value.length>0){var id=this.id;if(this.id.indexOf("OMS")>0){id=this.id.substr(0,this.id.indexOf("OMS"))}this.value=this.value.replace(/(^\s*)|(\s*$)/g,"");var sql="and lower("+id+") "+this.name+" lower('"+this.value+"') ";SqlWhere=SqlWhere+sql}});$(sqlWhereBlock).find("input[name='in']").each(function(){if(this.value.length>0){var id=this.id;if(this.id.indexOf("OMS")>0){id=this.id.substr(0,this.id.indexOf("OMS"))}this.value=this.value.replace(/(^\s*)|(\s*$)/g,"");var sql="and lower("+id+") "+this.name+" ("+this.value+") ";SqlWhere=SqlWhere+sql}});$(sqlWhereBlock).find("input[name='<']").each(function(){if(this.value.length>0){var id=this.id.substr(0,this.id.indexOf(this.name));if(this.id.indexOf("OMS")>0){id=this.id.substr(0,this.id.indexOf("OMS"))}this.value=this.value.replace(/(^\s*)|(\s*$)/g,"");if(this.id.indexOf("date")>0){var sql="and "+id+this.name+" to_date('"+this.value+"','yyyy-mm-dd') "}else{var sql="and "+id+this.name+"'"+this.value+"' "}SqlWhere=SqlWhere+sql}});$(sqlWhereBlock).find("input[name='>']").each(function(){if(this.value.length>0){var id=this.id.substr(0,this.id.indexOf(this.name));if(id.indexOf("OMS")>0){id=this.id.substr(0,this.id.indexOf("OMS"))}this.value=this.value.replace(/(^\s*)|(\s*$)/g,"");if(this.id.indexOf("date")>0){var sql="and "+id+this.name+" to_date('"+this.value+"','yyyy-mm-dd') "}else{var sql="and "+id+this.name+"'"+this.value+"' "}SqlWhere=SqlWhere+sql}});$(sqlWhereBlock).find("select[name='=']").each(function(){if(this.value.length>0){var id=this.id;if(this.id.indexOf("OMS")>0){id=this.id.substr(0,this.id.indexOf("OMS"))}this.value=this.value.replace(/(^\s*)|(\s*$)/g,"");var value=this.value.substr(this.value.indexOf(":")+1,this.value.length);var sql="and lower("+this.id+") "+this.name+" lower('"+value+"') ";SqlWhere=SqlWhere+sql}});return SqlWhere};this.getSqlWhere=function(arr,searchText,l_r){var sqlWhere="";var len=arr.length;var op=l_r||"center";if(searchText==""||searchText==undefined)return sqlWhere;searchText=String(searchText).toLowerCase();searchText=searchText.replace(/\*/g,"%");if(op=="center"){for(var i=0;i<len;i++){sqlWhere+=i==len-1?" lower("+arr[i]+") like lower('%"+searchText+"%')":" lower("+arr[i]+") like lower('%"+searchText+"%') or "}}else if(op=="left"){for(var i=0;i<len;i++){sqlWhere+=i==len-1?" lower("+arr[i]+") like lower('"+searchText+"%')":" lower("+arr[i]+") like lower('"+searchText+"%') or "}}else if(op=="right"){for(var i=0;i<len;i++){sqlWhere+=i==len-1?" lower("+arr[i]+") like lower('%"+searchText+"')":" lower("+arr[i]+") like lower('%"+searchText+"') or "}}console.log("sqlWhere: "+sqlWhere);return sqlWhere};this.pageInfoOp=function($scope,pagination){var pageinfo=pagination.split(",");$scope.currentPage=parseInt(pageinfo[0].split("=")[1]);$scope.oldPage=$scope.currentPage;$scope.pageSize=String(pageinfo[1].split("=")[1]);$scope.pages=parseInt(pageinfo[2].split("=")[1]);$scope.totalCount=parseInt(pageinfo[3].split("=")[1]);this.reloadFootable($scope.pageSize)};this.reloadFootable=function(pagesize){if(pagesize){$(".footable").data("page-size",pagesize)}$timeout(function(){$("table.footable").data("limit-navigation",0);$("table.footable").trigger("footable_redraw");$("table.footable").trigger("footable_initialized")})};this._loadStorage=function(key){var str=localStorage.getItem(key);return str};this._loadStorageObj=function(key){var backObj=null;try{backObj=JSON.parse(this._loadStorage(key))}catch(e){console.info(e)}return backObj};this._saveStorage=function(key,value){localStorage.setItem(key,value)};this._clearStorage=function(){localStorage.clear()};this._getCookie=function(key){var arr=document.cookie.split("; ");for(var i=0;i<arr.length;i+=1){var prefix=arr[i].split("=");if(prefix[0]==key){return prefix[1]}}return null};this._setCookie=function(key,value,days){if(days){var date=new Date;date.setTime(date.getTime()+days*24*60*60*1e3);var expires="; expires="+date.toGMTString()}else{var expires=""}document.cookie=key+"="+value+expires+"; path=/"};this._removeCookie=function(key){this._setCookie(key,1,1)};this.pageHistory=function(scope,savedata){};this.notify=function(notifyFn,msg,classes,timeout,templateUrl){notifyFn.closeAll();var inspiniaTemplate="views/common/notify.html";if(templateUrl){inspiniaTemplate=templateUrl}notifyFn({message:msg,classes:classes,templateUrl:inspiniaTemplate});if(timeout){$timeout(function(){notifyFn.closeAll()},timeout)}};this.notice=function(msg,classes,templateUrl,timeout){var template=templateUrl||"views/common/notify.html";notify.closeAll();var isArray=function isArray(obj){return Object.prototype.toString.call(obj)==="[object Array]"};if(isArray(msg)){template="views/common/notify-validate.html"}classes=classes||"alert-info";notify({message:msg,classes:classes,templateUrl:template});var t=classes=="alert-info"?1e3:3e3;var time=timeout||t;if(time){$timeout(function(){notify.closeAll()},time)}};this.openFrm=function(templateUrl,controller,$scope,windowClass,size,backdrop){var bgclass="";var sizeStr="";var back=true;if(windowClass){bgclass=windowClass}if(size){sizeStr=size}if(backdrop||backdrop==false){back=backdrop}return $modal.open({windowTemplateUrl:"",templateUrl:templateUrl,controller:controller,scope:$scope,size:sizeStr,windowClass:bgclass,resolve:{$parent:function(){return $scope}}})};this.open=function(controller,$scope,templateUrl,size,bgclass){var url=templateUrl||"views/common/Pop_Common.html";var bg_class=bgclass||" ";var sizeStr=size||" ";if(arguments.length<2){_this.notice("Error Frm Setting's","alert-warning");return}var key=$scope.FrmInfo.classid!="base_search"?$scope.FrmInfo.classid:$scope.FrmInfo.classid+$scope.FrmInfo.action;if($scope.FrmInfo.type=="checkbox"){url="views/common/Pop_Common.html";sizeStr="lg"}if($scope.FrmInfo.is_high){url="views/common/Pop_Common_High_New.html";sizeStr="md"}var commonSearchSetting={classId:$scope.FrmInfo.classid,action:$scope.FrmInfo.action,title:$scope.FrmInfo.title,checkbox:$scope.FrmInfo.type==="checkbox",postData:$scope.FrmInfo.postdata,sqlWhere:$scope.FrmInfo.sqlBlock,dataRelationName:$scope.FrmInfo.backdatas,keys:$scope.FrmInfo.searchlist,gridOptions:{columnDefs:$scope.FrmInfo.thead.map(function(old){return{field:old.code,headerName:old.name}})},showDeprecated:true};return $modal.openCommonSearch(commonSearchSetting);return this.openFrm(url,controller,$scope,bg_class,sizeStr)};this.openbillwfform=function(controller,$scope,templateUrl,size,bgclass){var url=templateUrl||"views/common/Pop_Common.html";var bg_class=bgclass||" ";var sizeStr=size||" ";return this.openFrm(url,controller,$scope,bg_class,sizeStr)};this.openCommonFrm=function(controller,$scope,FrmInfo,templateUrl,size){var url="";var sizeStr=size||" ";if(!templateUrl){url="views/common/Pop_Common.html"}else{url=templateUrl}if(FrmInfo!=null&&FrmInfo){this.FrmInfo=FrmInfo}else this.FrmInfo={title:"查询标题",thead:[{name:"编码",code:"code"},{name:"名称",code:"code"}]};var bgclass="";if(FrmInfo.bgclass){bgclass=FrmInfo.bgclass}return this.openFrm(url,controller,$scope,bgclass,sizeStr)};this.openCommonHighFrm=function(controller,$scope,FrmInfo,templateUrl,size){var url="";var sizeStr=size||" ";if(!templateUrl){url="views/common/Pop_Common_High.html"}else{url=templateUrl}if(FrmInfo!=null&&FrmInfo){this.FrmInfo=FrmInfo}else this.FrmInfo={title:"查询标题",thead:[{name:"编码",code:"code"},{name:"名称",code:"code"}]};var bgclass="";if(FrmInfo.bgclass){bgclass=FrmInfo.bgclass}alert("openCommonHighFrm");return this.openFrm(url,controller,$scope,bgclass,sizeStr)};this.saveToHistoryList=function(saveobj){if(sessionStorage){var historylist=sessionStorage.getItem("historylist");if(historylist&&historylist.length){historylist=JSON.parse(historylist);for(var i=0;i<historylist.length;i++){if(historylist[i].name==saveobj.name){historylist.splice(i,1);break}}historylist.unshift(saveobj)}else{historylist=[saveobj]}sessionStorage.setItem("historylist",JSON.stringify(historylist))}else{notify({message:"浏览器不支持SessionStorage",classes:"alert-danger",templateUrl:"views/common/notify.html"})}};this.getHistoryList=function(name){if(sessionStorage){var historylist=sessionStorage.getItem("historylist");if(!historylist){return null}var list=JSON.parse(historylist);var temp;for(var i=0;i<list.length;i++){if(list[i].name==name){temp=list[i];break}}if(temp){return temp.data}else{return null}}else{return null}};this.initGridOptions=function(scope,arr){for(var i=0;i<arr.length;i++){var options=arr[i]+"Options";scope[options]={editable:true}}};this.loadDictToColumns=function(args){var promises=[];args.columns.forEach(function(column){if(angular.isDefined(column.dictcode)){if(column.dictcode===".")column.dictcode=column.field;column.options=[];column.formatter=Slick.Formatters.SelectOption;console.log("查询词汇开始："+column.dictcode);promises.push(_this.RequestPost("base_search","searchdict",{dictcode:column.dictcode}).then(function(data){console.log("查询词汇完成："+column.dictcode);console.log("词汇数量 = "+data.dicts.length);console.log("加载词汇开始："+column.dictcode);data.dicts.forEach(function(dict){column.options.push({value:dict.dictvalue,desc:dict.dictname})});console.log("加载词汇完成："+column.dictcode)}))}});return $q.all(promises)};this.hiddenColumns=function(grid,columns){$.each(columns,function(index,item){grid.getColumns().splice(grid.getColumnIndex(item),1);grid.setColumns(grid.getColumns())})};function openCommonPopController(args){if(args.checkBox)args.scope.FrmInfo.type="checkbox";if(args.sqlBlock){args.scope.FrmInfo.sqlBlock=args.sqlBlock}else if(args.sqlWhere){var s=args.scope.FrmInfo.sqlBlock;args.scope.FrmInfo.sqlBlock=s?s+" and ("+args.sqlWhere+")":args.sqlWhere}return _this.open(CommonPopController,args.scope).result.then(args.then)}this.chooseUser=function(args){args.scope.FrmInfo={title:args.title?args.title:"选择用户",thead:[{name:"人员编码",code:"employee_code"},{name:"姓名",code:"employee_name"},{name:"部门编码",code:"dept_code"},{name:"部门名称",code:"dept_name"}],realtime:args.realtime?args.realtime:false,classid:"base_view_erpemployee_org",ignorecase:true,searchlist:["employee_code","employee_name","dept_code","dept_name"]};return openCommonPopController(args)};this.chooseCustomer=function(args){args.scope.FrmInfo={title:args.title?args.title:"选择客户",thead:[{name:"编号",code:"customer_code"},{name:"名称",code:"customer_name"}],classid:"customer_org",sqlBlock:"co.usable = 2",searchlist:["customer_code","customer_name"],realtime:args.realtime?args.realtime:false};if(args.postdata){args.scope.FrmInfo.postdata=args.postdata}else{args.scope.FrmInfo.postdata={}}return openCommonPopController(args)};self.chooseOpCenter=function(args){args.scope.FrmInfo={title:args.title?args.title:"选择运营中心",thead:[{name:"名称",code:"dept_name"},{name:"城市",code:"areaname"},{name:"区号",code:"telzone"}],classid:"dept",sqlBlock:"dept_type = 6",postdata:args.postdata,ignorecase:true,searchlist:["dept_name","dept_code","short_name"]};return openCommonPopController(args)};self.chooseDept=function(args){args.scope.FrmInfo={title:args.title?args.title:"选择部门",thead:[{name:"编码",code:"dept_code"},{name:"名称",code:"dept_name"}],classid:"dept",sqlBlock:"",postdata:args.postdata,sqlwhere:args.sqlwhere?args.sqlwhere:"",ignorecase:true,searchlist:["dept_name","dept_code"],realtime:args.realtime?args.realtime:false};return openCommonPopController(args)};this.chooseSaleCenter=function(args){args.scope.FrmInfo={title:args.title?args.title:"选择销售中心",thead:[{name:"名称",code:"dept_name"},{name:"简称",code:"short_name"}],classid:"dept",sqlBlock:"dept_type = 5",postdata:args.postdata,ignorecase:true,searchlist:["dept_name","dept_code","short_name"]};return openCommonPopController(args)};this.chooseCity=function(args){args.scope.FrmInfo={title:args.title?args.title:"选择城市",thead:[{name:"名称",code:"areaname"},{name:"区号",code:"telzone"}],classid:"scparea",sqlBlock:"areatype = 5",postdata:{search_flag:1,superid:args.superid>0?args.superid:0},searchlist:["areacode","areaname","assistcode","telzone","note","areaname_full"]};return openCommonPopController(args)};this.chooseArea=function(args){args.scope.FrmInfo={title:args.title?args.title:"选择地区",thead:[{name:"名称",code:"areaname"},{name:"区号",code:"telzone"}],classid:"scparea",sqlBlock:angular.isDefined(args.areatype)?"areatype = "+args.areatype:"",postdata:{search_flag:1,superid:args.superid>0?args.superid:0},searchlist:["areacode","areaname","assistcode","telzone","note","areaname_full"]};return openCommonPopController(args)};this.chooseProject=function(args){args.scope.FrmInfo={title:args.title?args.title:"选择工程项目",thead:[{name:"编码",code:"project_code"},{name:"名称",code:"project_name"},{name:"项目开发方",code:"dev_unit_name"},{name:"工程地址",code:"project_address"}],classid:"proj",searchlist:["project_code","project_name","project_address","dev_unit_name"]};return openCommonPopController(args)};this.chooseItem=function(args){args.scope.FrmInfo={title:args.title?args.title:"选择产品",thead:[{name:"编码",code:"item_code"},{name:"名称",code:"item_name"}],classid:"item_org",searchlist:["item_code","item_name"],sqlBlock:args.sqlBlock?args.sqlBlock:"",realtime:args.realtime?args.realtime:false};return openCommonPopController(args)};this.chooseUom=function(args){args.scope.FrmInfo={title:args.title?args.title:"选择计量单位",thead:[{name:"名称",code:"uom_name"},{name:"编码",code:"uom_code"}],classid:"uom",searchlist:["uom_code","uom_name"]};return openCommonPopController(args)};(function(){var d=$q.defer();var p=d.promise.then(function(){return self.RequestPost("scpuser","select",{userid:strUserId})});self.getUserQ=function(){d.resolve();return p}})()}function BasemanService(_BaseService,scope){angular.extend(this,_BaseService);this.searchBySql=function(scope,column,fun,FrmInfo){if(!FrmInfo){scope.FrmInfo={ignorecase:"true",is_high:true}}else{scope.FrmInfo=FrmInfo}scope.FrmInfo.thead=column.slice(2).map(function(column){if(!column.type){if(column.options)column.type="list";else if(column.cssClass==="amt")column.type="number";else column.type="string"}return{name:column.name,code:column.field,type:column.type,dicts:column.options}});sessionStorage.setItem("frmInfo",JSON.stringify(scope.FrmInfo));this.open(CommonPopController1,scope).result.then(function(sqlwhere){scope.sqlwhere=sqlwhere;fun({sqlwhere:scope.sqlwhere})})};this.initPagePostdata=function(scope){scope.oldPage=1;scope.currentPage=1;if(!scope.pageSize){scope.pageSize="20"}scope.totalCount=1;scope.pages=1;var pagination="pn=1,ps=20,pc=0,cn=0,ci=0";return pagination};this.getParameters=function(scope,param){if(!param)return;var isArray=function isArray(obj){return Object.prototype.toString.call(obj)==="[object Array]"};var temp_list=[];if(typeof param=="string"){temp_list.push(param)}else if(isArray(param)){temp_list=param}else{return}for(var i=0;i<temp_list.length;i++){this.RequestPost("drp_parameter","search",{importdataflag:i,sqlwhere:"other2='"+temp_list[i]+"' and usable=2"}).then(function(data){for(var j=0;j<data.drp_parameters.length;j++){data.drp_parameters[j].id=parseInt(data.drp_parameters[j].other1);data.drp_parameters[j].name=data.drp_parameters[j].other3}HczyCommon.arrSortId(data.drp_parameters);scope[temp_list[data.importdataflag]+"s"]=data.drp_parameters})}};this.initGird=function(){var wH=$(window).height();var titleH=58;var searchH=$(".title-form").height();var page_modal=37;var gridH=wH-titleH-searchH-page_modal-35;var treeH=wH-titleH-searchH-35;$(".wrapper .ibox .ui-widget,.wrapper .ibox .ag-blue").css("height",gridH);$(".TreeGridBox .ibox-title").css("height",treeH);$(".TreeGridBox .ibox-titleq .ui-widget,.TreeGridBox .ibox-titleq .ag-blue").css("height",treeH);var leftW=$(".TreeGridBox .ibox-titleq").width();$(".TreeGridBox .grid_modal.dbgridR").css("width"," calc( 100% - "+leftW+"px ) ");$(".TreeGridBox .grid_modal.dbgridR .ui-widget").css("height",treeH);var modal=$(".modal").has(".ui-widget,.ag-blue");if(!modal){return}for(var i=0;i<modal.length;i++){var x=modal[i];$("#"+x.id).on("shown.bs.modal",function(){var mH=$(x).find(".modal-body").height()||0;var fH=$(x).find(".form-inline").height()||0;$(x).find(".ui-widget,.ag-blue").css("height",mH-fH-30);if($(x).find(".ui-widget").parents(".tab-pane").length!=0){var fH=$(x).find(".ui-widget").parents(".tab-pane").find(".form-inline").outerHeight(true)||0;var tH=$(x).find(".nav.nav-tabs").outerHeight(true)||0;var pH=$(x).find(".ui-widget").parents(".tab-pane").find(".panel-body").outerHeight()||0-$(x).find(".ui-widget").parents(".tab-pane").find(".panel-body").height()||0;$(x).find(".ui-widget,.ag-blue").css("height",mH-tH-fH-pH)}})}};this.ReadonlyGrid=function(grid){var Columns=grid.getColumns();for(var i=0;i<Columns.length;i++){if(!Columns[i].editor){if(Columns[i].formatter==Slick.Formatters.SelectOption||!Columns[i].formatter){Columns[i].editor=Slick.Editors.ReadonlyText}}}grid.setColumns(Columns);var Options=grid.getOptions();if(Options){Options.editable=true;Options.autoEdit=false}grid.setOptions(Options);grid.render()};this.getSqlWhereBlock=function getSqlWhereBlock(SqlWhere,sqlWhereBlockID){if(!(SqlWhere==undefined||SqlWhere=="")){var SqlWhere=SqlWhere+" "}else{var SqlWhere="1=1 "}if(!(sqlWhereBlockID==undefined||sqlWhereBlockID=="")){var sqlWhereBlock=sqlWhereBlockID}else{var sqlWhereBlock="#sqlWhereBlock"}$(sqlWhereBlock).find("input[name='like']").each(function(){if(this.value.length>0){var id=this.id;if(this.id.indexOf("OMS")>0){id=this.id.substr(0,this.id.indexOf("OMS"))}this.value=this.value.replace(/(^\s*)|(\s*$)/g,"");var sql="and lower("+id+") "+this.name+" lower('%"+this.value+"%') ";SqlWhere=SqlWhere+sql}});$(sqlWhereBlock).find("input[name='=']").each(function(){if(this.value.length>0){var id=this.id;if(this.id.indexOf("OMS")>0){id=this.id.substr(0,this.id.indexOf("OMS"))}this.value=this.value.replace(/(^\s*)|(\s*$)/g,"");var sql="and lower("+id+") "+this.name+" lower('"+this.value+"') ";SqlWhere=SqlWhere+sql}});$(sqlWhereBlock).find("input[name='in']").each(function(){if(this.value.length>0){var id=this.id;if(this.id.indexOf("OMS")>0){id=this.id.substr(0,this.id.indexOf("OMS"))}this.value=this.value.replace(/(^\s*)|(\s*$)/g,"");var sql="and lower("+id+") "+this.name+" ("+this.value+") ";SqlWhere=SqlWhere+sql}});$(sqlWhereBlock).find("input[name='<']").each(function(){if(this.value.length>0){var id=this.id.substr(0,this.id.indexOf(this.name));if(this.id.indexOf("OMS")>0){id=this.id.substr(0,this.id.indexOf("OMS"))}this.value=this.value.replace(/(^\s*)|(\s*$)/g,"");if(this.id.indexOf("date")>0){var sql="and "+id+this.name+" to_date('"+this.value+"','yyyy-mm-dd') "}else{var sql="and "+id+this.name+"'"+this.value+"' "}SqlWhere=SqlWhere+sql}});$(sqlWhereBlock).find("input[name='>']").each(function(){if(this.value.length>0){var id=this.id.substr(0,this.id.indexOf(this.name));if(id.indexOf("OMS")>0){id=this.id.substr(0,this.id.indexOf("OMS"))}this.value=this.value.replace(/(^\s*)|(\s*$)/g,"");if(this.id.indexOf("date")>0){var sql="and "+id+this.name+" to_date('"+this.value+"','yyyy-mm-dd') "}else{var sql="and "+id+this.name+"'"+this.value+"' "}SqlWhere=SqlWhere+sql}});$(sqlWhereBlock).find("select[name='=']").each(function(){if(this.value.length>0){var id=this.id;if(this.id.indexOf("OMS")>0){id=this.id.substr(0,this.id.indexOf("OMS"))}this.value=this.value.replace(/(^\s*)|(\s*$)/g,"");var value=this.value.substr(this.value.indexOf(":")+1,this.value.length);var sql="and lower("+this.id+") "+this.name+" lower('"+value+"') ";SqlWhere=SqlWhere+sql}});return SqlWhere};this.openModal=function(e){e.Owner=window;var ws=[];function _(w){try{if(w["service"])ws.push(w);if(w.parent&&w.parent!=w)_(w.parent)}catch(e){console.log("openModal error... "+e)}}_(window);var D=ws[ws.length-1];return D["service"].openCommonModal(e)};this.closeModal=function(){var ws=[];function _(w){try{if(w["service"])ws.push(w);if(w.parent&&w.parent!=w)_(w.parent)}catch(e){console.log("closeModal error... "+e)}}_(window);var D=ws[ws.length-1];return D["service"].closeCommonModal()};this.setCurrWfCtrl=function(obj){var ws=[];function getSuperWindow(wnd){try{if(wnd["service"])ws.push(wnd);if(wnd.parent&&wnd.parent!=wnd)getSuperWindow(wnd.parent)}catch(e){console.log("openModal error... "+e)}}getSuperWindow(window);var D=ws[ws.length-1];return D["service"].currWfCtrl=obj};this.getCurrWfCtrl=function(){var ws=[];function getSuperWindow(wnd){try{if(wnd["service"])ws.push(wnd);if(wnd.parent&&wnd.parent!=wnd)getSuperWindow(wnd.parent)}catch(e){console.log("openModal error... "+e)}}getSuperWindow(window);var D=ws[ws.length-1];return D["service"].currWfCtrl};this.addFile=function(){};this.getPrintService=function(scope){scope.addFile=function addFile(){if(document.getElementById("file1")){document.getElementById("file1").parentNode.removeChild(document.getElementById("file1"))}var inputObj=document.createElement("input");inputObj.setAttribute("id","file1");inputObj.setAttribute("type","file");inputObj.setAttribute("name","docFile0");inputObj.setAttribute("style","visibility:hidden");inputObj.setAttribute("nv-file-select","");inputObj.setAttribute("uploader","uploader");document.body.appendChild(inputObj);inputObj.onchange=scope.uploadFile;inputObj.click()};scope.uploadFile=function uploadFile(o){if(o.target.files){try{$.ajaxFileUpload({url:"/web/scp/filesuploadsave2.do",type:"post",secureuri:false,fileElementId:"file1",dataType:"text",success:function(data,status){var userAgent=navigator.userAgent;data=JSON.parse(data);if(data.data){if(!scope.data.currItem.objattachs){scope.data.currItem.objattachs=[]}scope.data.currItem.objattachs.push({docid:data.data[0].docid+"",docname:data.data[0].docname,url:window.URL.createObjectURL(o.target.files[0])});scope.$apply()}},error:function(data,status,e){console.log(data)}})}finally{}}};scope.downloadAttFile=function downloadAttFile(file){window.open("/downloadfile.do?docid="+file.docid)};scope.deleteFile=function deleteFile(file){if(file&&file.docid>0){for(var i=0;i<scope.data.currItem.objattachs.length;i++){if(scope.data.currItem.objattachs[i].docid==file.docid){scope.data.currItem.objattachs.splice(i,1);break}}}}};this.uploadFile=function(o){if(o.target.files){try{$.ajaxFileUpload({url:"/web/scp/filesuploadsave2.do",type:"post",secureuri:false,fileElementId:"file1",dataType:"text",success:function(data,status){var userAgent=navigator.userAgent;data=JSON.parse(data);if(data.data){if(!this.data.currItem.objattachs){$scope.data.currItem.objattachs=[]}$scope.data.currItem.objattachs.push({docid:data.data[0].docid+"",docname:data.data[0].docname,url:window.URL.createObjectURL(o.target.files[0])});$scope.$apply()}},error:function(data,status,e){console.log(data)}})}finally{}}};this.downloadAttFile=function(file){window.open("/downloadfile.do?docid="+file.docid)};this.deleteFile=function(file,$scope){if(file&&file.docid>0){for(var i=0;i<$scope.data.currItem.objattachs.length;i++){if($scope.data.currItem.objattachs[i].docid==file.docid){$scope.data.currItem.objattachs.splice(i,1);break}}}};this.getAttachIcon=function(filename){var attachType="";var strExtName=filename?filename.split(".").length>1?filename.split(".")[1].toLowerCase():"":"";var filetypes=["doc","docx","ppt","pptx","xls","xlsx","txt"];var mediatypes=["wav","mp3"];var imagetypes=["jpg","png","gif","bmp","jpeg"];var drawtypes=["prt","drw","asm","sldprt","slddrw","sldasm"];var exetypes=["exe"];var pdftypes=["pdf"];if($.inArray(strExtName,filetypes)>=0){if(strExtName=="doc"||strExtName=="docx"){return"fa-file-word-o"}else if(strExtName=="ppt"||strExtName=="pptx"){return"fa-file-powerpoint-o"}else if(strExtName=="xls"||strExtName=="xlsx"){return"fa-file-excel-o"}else{return"fa-file-text-o"}}else if($.inArray(strExtName,imagetypes)>=0){return"fa-file-image-o"}else if($.inArray(strExtName,mediatypes)>=0){return"fa-file-image-o"}else if($.inArray(strExtName,drawtypes)>=0){return"fa-file-image-o"}else if($.inArray(strExtName,exetypes)>=0){return"fa-file-image-o"}else if($.inArray(strExtName,pdftypes)>=0){return"fa-file-pdf-o"}else{return"fa-file-text-o"}}}function FormValidatorService(notify,$timeout,$q,Magic){var self=this;function findLabel(selector){var jqSrc=$(selector);if(jqSrc.is("label"))return jqSrc;if(jqSrc.is(document))return $();var jqTarget=jqSrc.prev();if(!jqTarget.length)jqTarget=jqSrc.parent();if(!jqTarget.length)return $();return findLabel(jqTarget)}self.emptyMsg=function(args){var result=[];var $selected;if(args.selector)$selected=$(args.selector);else if(args.parent)$selected=$(args.parent).find(":text,select,textarea");else return result;$selected.filter(".non-empty").each(function(){var jqThis=$(this);var val=jqThis.val();var needPush;if(jqThis.is("select"))needPush=!val||val==="?";else needPush=!val;if(needPush)result.push(findLabel(jqThis).text())});return result};self.noEmptyAlert=function(msg){return Magic.swal({title:["以下内容不能为空，请补充："].concat(msg)})};self.noEmptyCheck=function(args){var checkMission=$q.defer();$q.when(args,self.emptyMsg).then(function(msg){if(msg.length){checkMission.reject(msg);self.noEmptyAlert(msg)}else checkMission.resolve()});return checkMission.promise};this.validatorFrom=function($scope,form){var is_pass=true;var msg=[];var evalValue=this.evalValue;if(typeof form=="undefined"||form==null&&form==""){form="#page-wrapper"}$(form).find("input").each(function(){if(this.attributes["data-rule-required"]!=undefined&&this.attributes["data-rule-required"].value){var str=this.attributes["data-rule-required"].value;if(this.attributes["data-msg-required"]!=undefined&&this.value.length==0&&evalValue(str,$scope)){var str=this.attributes["data-msg-required"].value;msg.push(str)}}if(this.attributes["data-rule-number"]!=undefined&&this.attributes["data-rule-number"].value){var str=this.attributes["data-rule-number"].value;if(this.attributes["data-msg-number"]!=undefined&&this.value.length==0&&evalValue(str,$scope)){var str=this.attributes["data-msg-number"].value;msg.push(str)}}});$(form).find("select[data-rule-required]").each(function(){var str=this.attributes["data-rule-required"].id;if(this.attributes["data-msg-required"]!=undefined&&this.value.length==0&&evalValue(str,$scope)){var str=this.attributes["data-msg-required"].id;msg.push(str)}});$(form).find("textarea[data-rule-required]").each(function(){var str=this.attributes["data-rule-required"].value;if(this.attributes["data-msg-required"]!=undefined&&this.value.length==0&&evalValue(str,$scope)){var str=this.attributes["data-msg-required"].value;msg.push(str)}});if(msg.length!=0){is_pass=false}if(!is_pass){notify.closeAll();notify({message:msg,classes:"alert-danger",templateUrl:"views/common/notify-validate.html"});setTimeout(function(){notify.closeAll()},5e3);return is_pass}if(is_pass){var postdata={level:0,is_pass:is_pass};this.setNullToSting($scope.data.currItem,postdata);is_pass=postdata.is_pass}if(!is_pass){msg.push("数据出现递归，请找管理员");notify.closeAll();notify({message:msg,classes:"alert-danger",templateUrl:"views/common/notify-validate.html"});setTimeout(function(){notify.closeAll()},5e3)}return is_pass};this.setNullToSting=function(arr,postdata){if(arr instanceof Array){for(var i=0;i<arr.length;i++){if(postdata.level>20){postdata.is_pass=false;return}this.setNullToSting(arr[i],postdata)}}else{postdata.level++;for(var x in arr){if(arr[x]instanceof Array){if(postdata.level>20){postdata.is_pass=false;postdata.name=x;return}this.setNullToSting(arr[x],postdata)}else if(arr[x]==null){arr[x]=""}}postdata.level--}};this.evalValue=function(str,$scope){var isRequired=false;if(str=="true"||str=="false"){isRequired=eval(str)}else{str=str.replace(/data./g,"$scope.data.");isRequired=eval(str)}return isRequired}}function AuthorizationService($q,$timeout,$rootScope,$location,$http){return{permissionModel:{permission:{},isPermissionLoaded:false},permissionCheck:function(nextRoteUrl){var deferred=$q.defer();var parentPointer=this;if(this.permissionModel.isPermissionLoaded){this.getPermission(this.permissionModel,nextRoteUrl,deferred)}else{$http({method:"POST",url:"/jsp/useraccessmenu.jsp",data:{flag:0},params:{classid:"base_modmenu",action:"useraccessrute",format:"mjson",id:Math.random(),loginguid:window.strLoginGuid}}).success(function(response){console.log("response:"+JSON.stringify(response.base_modmenus));parentPointer.permissionModel.permission=response.base_modmenus;parentPointer.permissionModel.isPermissionLoaded=true;parentPointer.getPermission(parentPointer.permissionModel,nextRoteUrl,deferred)}).error(function(response){console.log("读取用户菜单出错了:"+response)})}return deferred.promise},getPermission:function(permissionModel,nextRoteUrl,deferred){var ifPermissionPassed=false;var userAccessRouteMap=permissionModel.permission;for(var i=0,len=userAccessRouteMap.length;i<len;i++){var AccessRoute=userAccessRouteMap[i];var uisref="/"+AccessRoute.webrefaddr;console.log("webrefaddr:"+uisref+"  :"+nextRoteUrl);if(uisref===nextRoteUrl){ifPermissionPassed=true;break}}deferred.resolve(ifPermissionPassed)}}}function localeStorageServiceHelper($rootScope,$location,$state){if($location.search().showmode=="2"){$rootScope.showmode=2}else{$rootScope.showmode=1}this.showtab=window.parent.showtab=window.parent.showtab||new Array;this.hidetab=window.parent.hidetab=window.parent.hidetab||new Array;this.all_tabs=window.parent.all_tabs=window.parent.all_tabs||new Array;this.resizetab=function(){var maxchar=60;var len=0;var all=this.showtab.concat(this.hidetab);this.showtab.splice(0,this.showtab.length);this.hidetab.splice(0,this.hidetab.length);for(var i=0;i<all.length;i++){var t=all[i];len=len+(t.name||"").length+1.5;if(len>maxchar){var _hide=all.splice(i,all.length-i);for(var j=0;j<_hide.length;j++){this.hidetab.push(_hide[j])}break}else{this.showtab.push(t)}}};this.base_index=0;this.appendtab=function(t){this.base_index=this.base_index+1;this.showtab.splice(this.base_index,0,t);this.resizetab()};this.removetab=function(state_name){for(var i=this.showtab.length-1;i>=0;i--){if(this.showtab[i].state==state_name){this.showtab.splice(i,1)}}for(var i=this.hidetab.length-1;i>=0;i--){if(this.hidetab[i].state==state_name){this.hidetab.splice(i,1)}}for(var i=this.all_tabs.length-1;i>=0;i--){if(this.all_tabs[i].state==state_name){this.all_tabs.splice(i,1)}}this.resizetab()};this.setcurrent=function(params){var state=params.toState;var toParams=params.toParams||{};var isnew=true;window.userbean.new_tab=true;for(var i=0;i<this.showtab.length;i++){if(this.showtab[i].state==state.name&&angular.equals(this.showtab[i].params,toParams)){this.showtab[i].current=true;if(location.hash!=="#/home"){this.showtab[i].uri=location.hash}window.userbean.new_tab=false;isnew=false}else{this.showtab[i].current=false}}for(var i=0;i<this.hidetab.length;i++){if(this.hidetab[i].state==state.name&&angular.equals(this.showtab[i].params,toParams)){this.hidetab[i].current=true;window.userbean.new_tab=false;isnew=false}else{this.hidetab[i].current=false}}if(window.userbean.new_tab){var tmp={state:state.name,uri:"",current:true};if(toParams.title)tmp.name=toParams.title;else if(state.data)tmp.name=state.data.pageTitle;tmp.uri="#/"+tmp.state;tmp.uri=tmp.uri.replace(".","/");if(location.hash!=="#/home"&&location.hash!==""){tmp.uri=location.hash}tmp.templateUrl=state.templateUrl;if(window.location.origin){tmp.url=window.location.origin+"/web/index.jsp?t="+(new Date).getTime()+tmp.uri}else{tmp.url="/web/index.jsp?t="+(new Date).getTime()+tmp.uri}tmp.params=toParams;this.appendtab(tmp);this.all_tabs.push(tmp)}};this.length=0;this.items=new Array;for(var i=0;i<arguments.length;i+=2){if(typeof arguments[i+1]!="undefined"){this.items[arguments[i]]=arguments[i+1];this.length++}}this.remove=function(in_key){var tmp_value;if(typeof this.items[in_key]!="undefined"){this.length--;var tmp_value=this.items[in_key];delete this.items[in_key]}return tmp_value};this.get=function(in_key){return window.parent.CURR_STATE_C[in_key]};this.set=function(in_key,in_value){if(!angular.isString(in_key)){return}var str="#/"+in_key.replace(".","/");if(angular.isObject(in_value)){window.parent.CURR_STATE_C[in_key]=in_value;window.parent.CURR_LOCATION[in_key]=""}window.location.hash=str};this.hasItem=function(in_key){return typeof this.items[in_key]!="undefined"}}function HistoryDataService($timeout,$rootScope,$q){var historylist=[];var index=0;this.saveSessionData=function($scope){};this.getSessionData=function(){var _stateName=$rootScope.$state.$current.name;var _data=sessionStorage.getItem(_stateName);return _data};this.saveToHistoryList=function(){var c_url="#"+$rootScope.$state.$current.url;var c_name=$rootScope.$state.$current.name;var c_data=$rootScope.$state.$current.data;var is_found=false;if(historylist!=null&&historylist.length>0){for(var i=0;i<historylist.length;i++){if(historylist[i].name==c_name){is_found=true}}}if(!is_found){var _pageTitle="";if(c_data!=null&&c_data!="undefined"){_pageTitle=c_data.pageTitle}else{_pageTitle="dashboard_1";c_url="#/dashboards/dashboard_1"}console.log("pageTitle:"+_pageTitle);var trHtml='<li ui-sref-active="active"><a  ui-sref="'+c_name+'" href="'+c_url+'"  id="'+c_name+'">'+_pageTitle+"</a></li>";var $history=$("#history");var html=$history.html();$history.append(trHtml);historylist[index]={name:c_name};index++}}}function LoginUserService($q,$timeout,$rootScope,$location,$http){var index=0;return{permissionModel:{permission:{},isPermissionLoaded:false},permissionCheck:function(){var deferred=$q.defer();var parentPointer=this;if(this.permissionModel.isPermissionLoaded){index=index+1;console.log("has search:"+index);console.log("parentPointer:"+JSON.stringify(parentPointer));deferred.resolve(parentPointer)}else{console.log("new search:"+index);$http({method:"POST",url:"/jsp/base_search.jsp",data:{flag:0},params:{classid:"base_search",action:"loginuserinfo",format:"mjson",id:Math.random(),loginguid:window.strLoginGuid}}).success(function(response){console.log("loginuserifnos:"+JSON.stringify(response.loginuserifnos));var orgdata=response.loginuserifnos.orgdata[0];parentPointer.permissionModel.permission=response.loginuserifnos;parentPointer.permissionModel.isPermissionLoaded=true;deferred.resolve(parentPointer)}).error(function(response){console.log("读取用户菜单出错了:"+response)})}return deferred.promise},getPermission:function(permissionModel,nextRoteUrl,deferred){var ifPermissionPassed=false;deferred.resolve()}}}function localeStorageService($rootScope,localeStorageServiceHelper){this.showtab=localeStorageServiceHelper.showtab;this.hidetab=localeStorageServiceHelper.hidetab;this.all_tabs=localeStorageServiceHelper.all_tabs;this.appendtab=function(t){localeStorageServiceHelper.appendtab(t)};this.setcurrent=localeStorageServiceHelper.setcurrent.bind(localeStorageServiceHelper);this.removetab=function(state_name){localeStorageServiceHelper.removetab(state_name)};var _this=this;this.length=0;this.items=new Array;for(var i=0;i<arguments.length;i+=2){if(typeof arguments[i+1]!="undefined"){this.items[arguments[i]]=arguments[i+1];this.length++}}this.remove=function(in_key){var tmp_value;if(typeof this.items[in_key]!="undefined"){this.length--;var tmp_value=this.items[in_key];delete this.items[in_key]}var list=window.service.pagelist;if(list&&list.length){for(var i=0;i<list.length;i++){if(list[i].name==in_key){list.splice(i,1);break}}}return tmp_value};this.get=function(in_key){return window.parent.CURR_STATE_C[in_key]};this.set=function(in_key,in_value){if(typeof in_value!="undefined"){if(typeof this.items[in_key]=="undefined"){this.length++}this.items[in_key]=in_value}window.location.hash=str};this.hasItem=function(in_key){return typeof this.items[in_key]!="undefined"};this.pageHistory=function(scope,savedata){scope.$on("page_stat",function(event,data){var saveobj={name:data.fromState.name,title:data.fromState.data.pageTitle,data:savedata()};var list=window.service.pagelist;if(list==undefined||list.length==0){list=[];list.push(saveobj)}else{for(var i=0;i<list.length;i++){if(list[i].name==saveobj.name){list.splice(i,1);break}}list.unshift(saveobj)}window.service.pagelist=list})};this.getHistoryItem=function(_name){var list=window.service.pagelist;var temp=null;if(list==undefined||list.length==0){return temp}for(var i=0;i<list.length;i++){if(list[i].name==_name){temp=list[i];break}}if(temp){return temp.data}else{return temp}};this.clearHistoryList=function(){window.service.pagelist=[]};var listener=function(event,toState,toParams,fromState,fromParams){localeStorageServiceHelper.setcurrent(toState)}}app.service("BaseService",BaseService).service("BasemanService",["BaseService",BasemanService]).service("FormValidatorService",FormValidatorService).service("HistoryDataService",HistoryDataService).service("LoginUserService",LoginUserService).service("localeStorageService",localeStorageService).service("localeStorageServiceHelper",localeStorageServiceHelper);(function(){app.service("Magic",Magic).service("SlickGridService",SlickGridService).service("BillService",BillService).service("ProjService",ProjService);function Magic($q,BasemanService){console.log("Magic loading");var self=this;self.ifValue=function(any){return any?true:false};self.today=function(){return(new Date).Format("yyyy-MM-dd")};self.now=function(){return(new Date).Format("yyyy-MM-dd hh:mm:ss")};self.nowYear=function(){return(new Date).Format("yyyy")};self.nowMonth=function(){return(new Date).Format("MM")};self.isNotEmptyArray=function(any){return angular.isArray(any)&&any.length>0};self.isStr=angular.isString;self.isNum=function(any){return angular.isNumber(any)&&any===any};self.isInt=function(any){return self.isNum(any)&&any%1===0};self.isStrOfNum=function(any){return self.isStr(any)&&/^-?\d{1,3}(,?\d{3})*(\.\d+)?$/.test(any)};self.likeNum=function(any){return self.isNum(any)||self.isStrOfNum(any)};self.isStrOfInt=function(any){return self.isStr(any)&&/^-?\d{1,3}(,?\d{3})*(\.0+)?$/.test(any)};self.isStrOrNum=function(any){return self.isStr(any)||self.isNum(any)};self.isObjOrFun=function(any){return angular.isObject(any)||angular.isFunction(any)};self.toFun=function(funOrNot){if(angular.isFunction(funOrNot))return funOrNot;return function(){return funOrNot}};self.toNum=function(any,failReturn){if(any instanceof Number)any=any.valueOf();if(self.isNum(any))return any;if(!self.isNum(failReturn))failReturn=0;if(self.isStrOfNum(any))return Number(any.replace(/,/g,""));return failReturn};self.toInt=function(any,failReturn){if(any instanceof Number)any=any.valueOf();if(self.isInt(any))return any;if(!self.isInt(failReturn))failReturn=0;if(self.isStrOfInt(any))return Number(any.replace(/,/g,""));return failReturn};self.commonSplit=function(str){return str.split(/[\s`·~!！@#$￥%^…&*()（）\-—+=\[\]【】{}｛｝\\|、;；:：'‘’"“”,，.。<>《》/?？]+/)};self.runQ=function(fun){if(angular.isFunction(fun))return $q.when(undefined,fun);return $q.reject("非函数无法异步运行")};self.forMonth=function(callBack){for(var month=1;month<=12;month++)if(callBack(month))break};(function(){function swalArg(args){if(angular.isObject(args[0])&&!angular.isArray(args[0]))return args[0];return{title:args[0],text:args[1],type:args[2]}}var timer=1e3;self.swal=function(){args=swalArg(arguments);["title","text"].forEach(function(key){if(self.isNotEmptyArray(args[key])){args[key]=args[key].reduce(function(result,element){return result+"<br>"+element});args.html=true}});var d=$q.defer();swal(args,function(value){if(angular.isUndefined(args.closeOnConfirm)||args.closeOnConfirm===true)swal.close();if(args.showCancelButton){if(value===true)d.resolve();else d.reject()}else d.resolve()});return d.promise};self.swalConfirm=function(){args=swalArg(arguments);angular.extend(args,{type:"warning",showConfirmButton:true,showCancelButton:true,allowEscapeKey:false,allowOutsideClick:false,timer:null});return self.swal(args)};self.swalInfo=function(){args=swalArg(arguments);angular.extend(args,{type:"info",timer:null});return self.swal(args)};self.swalSuccess=function(){args=swalArg(arguments);angular.extend(args,{type:"success",timer:angular.isDefined(args.timer)?args.timer:timer});return self.swal(args)};self.swalError=function(){args=swalArg(arguments);args.type="error";angular.extend(args,{type:"error",timer:null});return self.swal(args)};self.swalConfirmThenSuccess=function(args){angular.extend(args,{closeOnConfirm:false});var okFun=args.okFun;delete args.okFun;var okTitle=args.okTitle||"成功";delete args.okTitle;var theResult;return $q.when(args).then(self.swalConfirm).then(angular.noop).then(okFun).then(function(result){theResult=result;return okTitle},function(reason){swal.close();return $q.reject(reason)}).then(self.swalSuccess).then(function(){return theResult})}})();self.assignProperty=function(srcObj,destObj,keys){var keyIsSame=angular.isArray(keys);angular.forEach(keys,function(destKey,srcKey){destObj[destKey]=srcObj[keyIsSame?destKey:srcKey]});return destObj};self.predefineProperty=function(destObj,defineObj){Object.keys(defineObj).forEach(function(key){if(!(key in destObj))destObj[key]=defineObj[key]});return destObj};self.defaultCatch=function(reason){console.error(reason);var msg;if(angular.isString(reason))msg=reason;else if(angular.isObject(reason)&&reason.id)msg=reason.message;var promise=$q.when();if(msg)promise=promise.then(self.swalError.bind(self,msg));promise=promise.then($q.reject.bind($q,reason));return promise};self.deferPromise=function(){var deferred=$q.defer();var promise=deferred.promise;["resolve","reject"].forEach(function(key){promise[key]=deferred[key].bind(deferred)});return promise};self.forLoop=function(start,end,looper){var isBreak=false;for(var i=start;i<end;i++){if(looper(i)===true){isBreak=true;break}}return isBreak};self.chooseFile=function(params){var promise=self.deferPromise();try{var id="file1";$("#"+id).remove();var fileInput=$("<input>");fileInput.css("display","none");fileInput.attr("id",id);fileInput.attr("type","file");fileInput.attr("name","docFile0");fileInput.attr("uploader","uploader");$("body").append(fileInput);var promise=self.deferPromise();fileInput.change(function(event){if(event.target.files){promise.resolve({element:$(event.target),files:event.target.files})}else{promise.reject("cancel")}});fileInput.click()}catch(error){promise.reject(error)}finally{return promise}};self.uploadFile=function(params){return $q.when(params).then(self.chooseFile).then(function(p){var promise=self.deferPromise();var uploadParams={url:"/web/scp/filesuploadsave2.do",type:"post",secureuri:false,fileElementId:p.element.attr("id"),dataType:"json",success:function(data,status){if(data.failure)promise.reject(data.msg);promise.resolve(data)},error:function(data,status,e){promise.reject(data)}};console.log("uploadParams",uploadParams);$.ajaxFileUpload(uploadParams);return promise})};console.log("Magic loaded")}function AgGridService($q,BasemanService,Magic){console.log("AgGridService loading");var self=this;function gridPredefine(destObj,defineObj){Object.keys(defineObj).forEach(function(key){var defineValue=defineObj[key];if(angular.isObject(defineValue)&&!angular.isArray(defineValue)){var destValue;if(key in destObj){destValue=destObj[key]}else{destValue={};destObj[key]=destValue}if(angular.isObject(destValue)&&!angular.isArray(destValue)){gridPredefine(destValue,defineValue)}}else if(!(key in destObj)){destObj[key]=defineValue}});return destObj}self.createAgGrid=function(div,gridOptions,returnPromise){gridOptions.hcReady=gridOptions.hcReady||Magic.deferPromise();if(returnPromise===true){return $q.when().then(function(){return self.createAgGrid(div,gridOptions,false)})}function handleError(err){console.error(err);return Magic.swalError(err).then($q.reject.bind($q,err))}if(angular.isString(div)&&div.charAt(0)!=="#")div="#"+div;var $grid=$(div);if(!$grid.length)handleError("表格要依附的DOM元素"+div+"不存在");if(!angular.isArray(gridOptions.columnDefs))handleError("options.columnDefs 未定义，请检查列定义和表格选项的顺序");var dictColDefs=gridOptions.columnDefs.filter(function(colDef){return colDef.hcDictCode&&angular.isString(colDef.hcDictCode)});if(dictColDefs.length){dictColDefs.forEach(function(colDef){colDef.type="词汇";if(colDef.hcDictCode==="*")colDef.hcDictCode=colDef.field});var dictPromises=dictColDefs.map(function(colDef){return BasemanService.RequestPost("base_search","searchdict",{dictcode:colDef.hcDictCode}).then(function(response){var values=response.dicts.map(function(e){return e.dictvalue});var names=response.dicts.map(function(e){return e.dictname});colDef.cellEditorParams={values:values,names:names,cellRenderer:function(params){if(names.length&&values.length&&names.length===values.length){var index=values.findIndex(function(value){return value==params.value});if(index>=0)return names[index]}return""}}})});$q.all(dictPromises.concat(gridOptions.hcReady)).then(function(){gridOptions.api.setColumnDefs(gridOptions.columnDefs);gridOptions.columnApi.resetColumnState()})}function getDefaultCellStyle(params){var style={};if(gridOptions.defaultColDef){var defaultStyle=gridOptions.defaultColDef.cellStyle;if(defaultStyle){if(angular.isObject(defaultStyle))style=defaultStyle;else if(angular.isFunction(defaultStyle))style=defaultStyle(params)}}return style}var defaultGridOptions={suppressColumnVirtualisation:true,enableRangeSelection:true,enableColResize:true,hcTheme:"ag-blue",suppressLoadingOverlay:true,suppressNoRowsOverlay:true,defaultColDef:{headerName:"尚未定义列名",width:120,minWidth:60,maxWidth:400},columnTypes:{"序号":{headerName:"序号",pinned:"left",suppressMovable:true,width:58,suppressResize:true,suppressSizeToFit:true,suppressAutoSize:true,edtiable:false,valueGetter:"Number(node.id)+1",cellStyle:function(params){return angular.extend(getDefaultCellStyle(params),{"text-align":"center","font-weight":"bold"})}},"金额":{cellStyle:function(params){return angular.extend(getDefaultCellStyle(params),{"text-align":"right"})},valueFormatter:function(params){if(Magic.isNum(params.value)||Magic.isStrOfNum(params.value))return HczyCommon.formatMoney(params.value);return params.value}},"万元":{cellStyle:function(params){return angular.extend(getDefaultCellStyle(params),{"text-align":"right"})}},"百分比":{cellStyle:function(params){return angular.extend(getDefaultCellStyle(params),{"text-align":"right"})}},"数量":{cellStyle:function(params){return angular.extend(getDefaultCellStyle(params),{"text-align":"right"})}},"词汇":{cellEditor:agGrid.EnterpriseBoot.RICH_SELECT,valueFormatter:function(params){var cellEditorParams=params.column.colDef.cellEditorParams;if(cellEditorParams&&Magic.isNotEmptyArray(cellEditorParams.values)&&Magic.isNotEmptyArray(cellEditorParams.names)&&cellEditorParams.values.length===cellEditorParams.names.length){var index=cellEditorParams.values.findIndex(function(value){return value==params.value});if(index>=0)return cellEditorParams.names[index]}return""},filterParams:{valueGetter:function(node){var value=node.data[this.colDef.field];value=this.colDef.valueFormatter({value:value,column:{colDef:this.colDef}});return value}}},"大文本":{cellEditor:agGrid.CellEditorFactory.LARGE_TEXT},"日期":{width:90,cellEditor:DateCellEditor,valueFormatter:function(params){if(angular.isString(params.value)&&params.value.length>10)return params.value.substr(0,10);return params.value}},"时间":{width:124}},localeText:{page:"daPage",more:"daMore",to:"daTo",of:"daOf",next:"下一个",last:"最后一个",first:"第一个",previous:"前一个",loadingOoo:"加载中...",selectAll:"所有",searchOoo:"请输入搜索内容...",blanks:"空白",filterOoo:"过滤中...",applyFilter:"应用过滤器...",equals:"等于",lessThan:"小于",greaterThan:"大于",contains:"包含",NotEquals:"不等于",startsWith:"以此开头",endsWith:"以此结尾",group:"单列分组",columns:"多列",rowGroupColumns:"分组列",rowGroupColumnsEmptyMessage:"拖拽分组区域",valueColumns:"求值列",pivotMode:"固定列模块",groups:"多列分组",values:"多列求值",pivots:"多列固定",valueColumnsEmptyMessage:"拖拽固定区域",pivotColumnsEmptyMessage:"拖拽求值区域",noRowsToShow:"表格为空",pinColumn:"固定列",valueAggregation:"求平均值",autosizeThiscolumn:"当前列宽度自适应",autosizeAllColumns:"所有列宽度自适应",groupBy:"当前列分组",ungroupBy:"分组还原",resetColumns:"恢复列宽",expandAll:"伸展",collapseAll:"收缩",toolPanel:"工具版面",export:"导出",csvExport:"CSV导出",excelExport:"Excel导出",pinLeft:"列左固定",pinRight:"列右固定",noPin:"不固定",sum:"求和",min:"最小值",max:"最大值",first:"第一个",last:"最后一个",none:"空",count:"次数",average:"平均",copy:"复制",copyWithHeaders:"复制加上列名",ctrlC:"Ctrl C",paste:"粘贴",ctrlV:"Ctrl V"},getContextMenuItems:function(params){var items=params.defaultItems.filter(function(item){return["toolPanel","export"].indexOf(item)<0});if(gridOptions.suppressExcelExport!==true)items.push("excelExport");return items},getMainMenuItems:function(params){var items=params.defaultItems.filter(function(item){return["toolPanel"].indexOf(item)<0});return items}};gridPredefine(gridOptions,defaultGridOptions);gridOptions.hcDefaultOptions=defaultGridOptions;if(Magic.isNotEmptyArray(gridOptions.columnDefs)){gridOptions.columnDefs.forEach(function(colDef){if(angular.isString(colDef.type)){var colDefOfType=gridOptions.columnTypes[colDef.type];if(angular.isObject(colDefOfType))gridPredefine(colDef,colDefOfType)}})}gridOptions.columnDefs.forEach(function(colDef){if(colDef.valueFormatter)colDef.cellFormatter=colDef.valueFormatter});$grid.addClass(gridOptions.hcTheme);var onGridReady=gridOptions.onGridReady;gridOptions.onGridReady=function(params){gridOptions.hcReady.resolve(gridOptions);if(angular.isFunction(onGridReady))onGridReady(params)};new agGrid.Grid($grid.get(0),gridOptions);if(angular.isObject(gridOptions.hcEvents)){angular.forEach(gridOptions.hcEvents,function(eventHandler,eventName){gridOptions.api.addEventListener(eventName,eventHandler)})}gridOptions.hcApi={getFocusedRowIndex:function(){var cell=gridOptions.api.getFocusedCell();if(cell)return cell.rowIndex;return-1},getFocusedNode:function(){var rowIndex=gridOptions.hcApi.getFocusedRowIndex();if(rowIndex>=0)return gridOptions.hcApi.getNodeOfRowIndex(rowIndex);return null},getFocusedData:function(){var rowIndex=gridOptions.hcApi.getFocusedRowIndex();if(rowIndex>=0)return gridOptions.hcApi.getDataOfRowIndex(rowIndex);return null},getNodeOfRowIndex:function(rowIndex){return gridOptions.api.getModel().getRow(rowIndex)},getDataOfRowIndex:function(rowIndex){return gridOptions.hcApi.getNodeOfRowIndex(rowIndex).data},setRowData:function(rowData){gridOptions.api.setRowData(rowData);gridOptions.columnApi.autoSizeAllColumns()},setFocusedCell:function(rowIndex,colKey){gridOptions.api.setFocusedCell(rowIndex,colKey);gridOptions.api.rangeController.setRangeToCell(gridOptions.api.getFocusedCell());gridOptions.api.ensureIndexVisible(rowIndex)},getDefaultCellStyle:getDefaultCellStyle};gridOptions.api.hcApi=gridOptions.hcApi;console.info("ag-grid"+div+" gridOptions如下：");console.info(gridOptions);return gridOptions};function DateCellEditor(){}angular.extend(DateCellEditor.prototype,{init:function(params){this.params=params;$input=$('<INPUT type="text">');this.$input=$input;$input.val(params.value);$input.datetimepicker({format:"yyyy-mm-dd",minView:"month",todayBtn:true,todayHighlight:true,language:"zh-CN",autoclose:true});$input.focus().select()},getGui:function(){return this.$input[0]},afterGuiAttached:function(){this.$input.focus().select()},getValue:function(){return this.$input.val()},destroy:function(){this.params.api.stopEditing(false);$input.datetimepicker("hide");$input.datetimepicker("destroy");$input.remove()}});console.log("AgGridService loaded")}function SlickGridService(BasemanService){console.log("SlickGridService loading");var self=this;self.setData=function(args){var errTitle="调用SlickGridService.setData失败";if(args==null)BasemanService.swal(errTitle,"需要指定参数");var grid=args.grid;if(grid==null)BasemanService.swal(errTitle,"需要指定参数【grid-表格】");var data=args.data;if(data==null)data=[];else if(!angular.isArray(data))data=[data];var gridData=grid.getData();var type=args.type;switch(type){case"push":Array.prototype.push.apply(gridData,data);break;case"unshift":Array.prototype.unshift.apply(gridData,data);break;case"splice":var index=args.index>0?args.index:0;var deleteCount=args.deleteCount>0?args.deleteCount:0;Array.prototype.splice.apply(gridData,[index,deleteCount].concat(data));break;default:gridData=data}angular.forEach(gridData,function(rowData,row){rowData.seq=row+1});grid.setData(gridData);grid.render()};self.columnSeq=function(){return{field:"seq",name:"序号",width:48,cssClass:"uid"}};console.log("SlickGridService loaded")}function BillService($q,BasemanService,SlickGridService,Magic){console.log("BillService loading");var self=this;self.decorateHead=function(scope,option){scope.gridButton=option.gridButton||function(row,cell,value,column,rowData){var buttonHtml='<button class="btn btn-sm btn-info dropdown-toggle viewbtn" style="padding-top: 1px;padding-bottom: 1px;margin-bottom: 1px;">查看</button>';if(scope.canDelete(rowData))buttonHtml+='<button class="btn btn-sm btn-info dropdown-toggle delbtn" style="padding-top: 1px;padding-bottom: 1px;margin-bottom: 1px;">删除</button>';return buttonHtml};option.canDelete=option.canDelete||function(rowData){return angular.isObject(rowData)&&rowData.stat<=1};option.headerColumns.unshift(SlickGridService.columnSeq(),{name:"操作",width:82,formatter:scope.gridButton});option.headerOptions=option.headerOptions||{enableCellNavigation:true,enableColumnReorder:false,editable:false,enableAddRow:false,asyncEditorLoading:false,autoEdit:true,autoHeight:false};option.searchObj=option.searchObj||function(){return{}};option.action=option.action||"search";angular.forEach(["title","classId","idField","codeField","searchObj","headerColumns","headerOptions","canDelete"],function(key){scope[key]=Magic.toFun(option[key])});scope.detailUrl=angular.isFunction(option.detailUrl)?option.detailUrl:function(id){if(!Magic.isStrOrNum(id))id=0;option.detailUrl=option.detailUrl.replace(/#/g,"?t="+(new Date).getTime()+"#");return option.detailUrl+id};var codeColumn;scope.headerColumns().some(function(column){var b=column.field===scope.codeField();if(b)codeColumn=column;return b});BasemanService.loadDictToColumns({columns:scope.headerColumns()});scope.headerGrid=Magic.toFun(new Slick.Grid("#headerGrid",[],scope.headerColumns(),scope.headerOptions()));scope.headerGrid().onClick.subscribe(function(e,args){var jqTarget=$(e.target);var stop=true;if(jqTarget.hasClass("viewbtn")){scope.editData(args.row)}else if(jqTarget.hasClass("delbtn")){scope.delData(args.row)}else{stop=false}if(stop)e.stopImmediatePropagation()});scope.headerGrid().onDblClick.subscribe(function(e,args){scope.editData(args.row);e.stopImmediatePropagation()});scope.searchBySql=function(){scope.FrmInfo={ignorecase:"true",is_high:true};scope.FrmInfo.thead=scope.headerColumns().slice(2).map(function(column){if(!column.type){if(column.options)column.type="list";else if(column.cssClass==="amt")column.type="number";else column.type="string"}return{name:column.name,code:column.field,type:column.type,dicts:column.options}});sessionStorage.setItem("frmInfo",JSON.stringify(scope.FrmInfo));return BasemanService.open(CommonPopController1,scope).result.then(function(sqlwhere){scope.sqlwhere=sqlwhere}).then(scope.searchData)};scope.searchData=function(postData){if(postData)postData=angular.extend(scope.searchObj(),postData);else postData=scope.searchObj();if(!postData.sqlwhere)postData.sqlwhere=scope.sqlwhere;if(!postData.pagination){scope.oldPage=1;scope.currentPage=1;if(!scope.pageSize)scope.pageSize="20";scope.totalCount=1;scope.pages=1;postData.pagination="pn=1,ps="+scope.pageSize+",pc=0,cn=0,ci=0"}var classId=scope.classId();return BasemanService.RequestPost(classId,option.action,postData).then(function(data){SlickGridService.setData({grid:scope.headerGrid(),data:data[classId+"s"]});BasemanService.pageInfoOp(scope,data.pagination)})};scope.editData=function(row){var id;if(angular.isNumber(row)&&row>=0)id=scope.headerGrid().getData()[row][scope.idField()];else id=0;scope.editDataById(id)};scope.editDataById=function(id){BasemanService.openModal({url:scope.detailUrl(id),title:scope.title(),obj:scope,style:option.detailStyle,ondestroy:scope.searchData})};scope.delData=function(row){var rowData=scope.headerGrid().getData()[row];var id=rowData[scope.idField()];var code=rowData[scope.codeField()];return Magic.swalConfirmThenSuccess({title:"确定要删除"+"【"+codeColumn.name+"】为【"+code+"】"+"的【"+scope.title()+"】吗？",okTitle:"成功删除",okFun:function(){return $q.when().then(function(){var postData={};postData[scope.idField()]=id;return BasemanService.RequestPost(scope.classId(),"delete",postData)}).then(function(){SlickGridService.setData({grid:scope.headerGrid(),type:"splice",index:row,deleteCount:1})})}})};BasemanService.initGird();BasemanService.pageGridInit(scope)};self.closeWindow=function(){if(window!==window.parent){BasemanService.closeModal()}else{window.close()}};console.log("BillService loaded")}function ProjService(BasemanService){console.log("ProjService loading");var self=this;self.projLikeness=function(params){var $scope=params.scope;$scope.FrmInfo={title:"相似性检索",thead:[{name:"编码",code:"project_code"},{name:"名称",code:"project_name"},{name:"单据状态",code:"stat",type:"list",dicts:[{value:"1",desc:"制单"},{value:"3",desc:"流程中"},{value:"5",desc:"已审核"}]},{name:"项目开发方",code:"dev_unit_name"},{name:"工程地址",code:"project_address"}],classid:"proj",postdata:{searchflag:2,project_id:params.project_id},searchlist:["project_code","project_name","project_address","dev_unit_name"]};return BasemanService.open(CommonPopController,$scope).result};console.log("ProjService loaded")}})()});